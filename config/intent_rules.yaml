# Intent Rules Configuration for Kumon Assistant
# 
# This configuration defines all intent classification rules following the
# structure defined in schemas/intent_rules_schema.json
#
# Performance Requirements:
# - P95 ≤ 20ms total latency
# - Prefilter_literal ≥ 3 characters
# - Collision rate < 5%
# - 100% node coverage

metadata:
  version: "1.0.0"
  created_at: "2025-01-01T00:00:00Z"
  updated_at: "2025-01-01T00:00:00Z"
  author: "Claude Code - Intent Classifier Refactoring"
  description: "Production intent rules migrated from legacy IntentClassifier and PatternScorer"

intents:
  # ===============================
  # GREETING STAGE RULES
  # ===============================
  
  - id: "greeting_initial_hello"
    rule_version: "1.0.0"
    priority: 90
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "olá"
    pattern: '\b(oi|olá|hello|hi|bom\s*dia|boa\s*tarde|boa\s*noite)\b'
    description: "Initial greetings and hello messages"
    node_mapping: ["greeting"]
    context_requirements:
      stages: ["greeting"]
    risk_cost: 1.0
    slots:
      - name: "greeting_type"
        group: "greeting_word"
        required: false

  - id: "greeting_name_introduction"
    rule_version: "1.0.0"
    priority: 85
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "nome"
    pattern: '\b(meu\s+nome\s+(é|e)|me\s+chamo|sou\s+(o|a))\s*(?P<parent_name>[A-ZÁÊÉÔÕÂÎÇÜ][a-záêéôõâîçü]{2,}(?:\s+[A-ZÁÊÉÔÕÂÎÇÜ][a-záêéôõâîçü]{2,})*)'
    description: "Name introduction during greeting"
    node_mapping: ["greeting", "qualification_name_collection"]
    context_requirements:
      stages: ["greeting", "qualification"]
    risk_cost: 0.5
    slots:
      - name: "parent_name"
        group: "parent_name"
        required: true
        validation: '^[A-ZÁÊÉÔÕÂÎÇÜ][a-záêéôõâîçü]{2,}(?:\s+[A-ZÁÊÉÔÕÂÎÇÜ][a-záêéôõâîçü]{2,})*$'

  - id: "greeting_name_response"
    rule_version: "1.0.0"
    priority: 80
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "gabriel"  # Example - will be dynamic in actual implementation
    pattern: '^(?P<parent_name>[A-ZÁÊÉÔÕÂÎÇÜ][a-záêéôõâîçü]{2,}(?:\s+[A-ZÁÊÉÔÕÂÎÇÜ][a-záêéôõâîçü]{2,})*)$'
    description: "Single name response during qualification"
    node_mapping: ["qualification_name_collection"]
    context_requirements:
      stages: ["qualification"]
      exclude_stages: ["greeting"]  # Don't classify names as greeting when in qualification
    risk_cost: 0.3
    slots:
      - name: "parent_name"
        group: "parent_name"
        required: true

  - id: "greeting_child_introduction"
    rule_version: "1.0.0" 
    priority: 75
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "filho"
    pattern: '\b(meu\s+filho|minha\s+filha|nome\s+(é|e)|se\s+chama)\s*(?P<child_name>[A-ZÁÊÉÔÕÂÎÇÜ][a-záêéôõâîçü]{2,})'
    description: "Child name and information introduction"
    node_mapping: ["qualification_name_collection", "qualification_age_collection"]
    context_requirements:
      stages: ["greeting", "qualification"]
    risk_cost: 0.4
    slots:
      - name: "child_name"
        group: "child_name"
        required: true

  - id: "greeting_age_mention"
    rule_version: "1.0.0"
    priority: 70
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "anos"
    pattern: '\b(tem|está\s+com|idade|tem\s*(?P<student_age>\d{1,2})\s*anos?|\d{1,2}\s*anos?)\b'
    description: "Age mention during conversation"
    node_mapping: ["qualification_age_collection"]
    context_requirements:
      stages: ["greeting", "qualification"]
    risk_cost: 0.3
    slots:
      - name: "student_age"
        group: "student_age"
        required: true
        validation: '^\d{1,2}$'

  # ===============================
  # INFORMATION REQUEST RULES
  # ===============================

  - id: "info_general_inquiry"
    rule_version: "1.0.0"
    priority: 70
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "saber"
    pattern: '\b(gostaria\s+de\s+saber|quero\s+(informações|saber)|quero\s+conhecer|preciso\s+entender)\b'
    description: "General information request"
    node_mapping: ["information"]
    context_requirements:
      stages: ["greeting", "qualification", "information"]
    risk_cost: 0.8
    slots: []

  - id: "info_kumon_about"
    rule_version: "1.0.0"
    priority: 68
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "kumon"
    pattern: '\b(conhecer\s+o\s+kumon|saber\s+mais|informações\s+sobre|o\s+que\s+(é|e)\s+kumon)\b'
    description: "Information about Kumon methodology"
    node_mapping: ["information", "methodology_explanation"]
    context_requirements:
      stages: ["information"]
    risk_cost: 0.6
    slots: []

  - id: "info_mathematics_program"
    rule_version: "1.0.0"
    priority: 65
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "matemática"
    pattern: '\b(matemática|math|cálculo|números?|conta|aritmética)\b'
    description: "Mathematics program information"
    node_mapping: ["program_explanation", "qualification_programs"]
    context_requirements:
      stages: ["information", "qualification"]
    risk_cost: 0.4
    slots:
      - name: "programs_of_interest"
        group: "program_type"
        required: false

  - id: "info_portuguese_program"
    rule_version: "1.0.0"
    priority: 65
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "português"
    pattern: '\b(português|port|leitura|escrita|redação|texto)\b'
    description: "Portuguese program information"
    node_mapping: ["program_explanation", "qualification_programs"]
    context_requirements:
      stages: ["information", "qualification"]
    risk_cost: 0.4
    slots:
      - name: "programs_of_interest"
        group: "program_type" 
        required: false

  - id: "info_english_program"
    rule_version: "1.0.0"
    priority: 65
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "inglês"
    pattern: '\b(inglês|english|idioma)\b'
    description: "English program information"
    node_mapping: ["program_explanation", "qualification_programs"]
    context_requirements:
      stages: ["information", "qualification"]
    risk_cost: 0.4
    slots:
      - name: "programs_of_interest"
        group: "program_type"
        required: false

  - id: "info_pricing"
    rule_version: "1.0.0"
    priority: 63
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "preço"
    pattern: '\b(preço|valor|custa|quanto|investimento|mensalidade|quanto\s+custa)\b'
    description: "Pricing information request"
    node_mapping: ["information"]
    context_requirements:
      stages: ["information"]
    risk_cost: 0.7
    slots: []

  - id: "info_methodology"
    rule_version: "1.0.0"
    priority: 62
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "funciona"
    pattern: '\b(como\s+funciona|metodologia|método|ensino|diferença|funciona\s+mesmo)\b'
    description: "Methodology information request"
    node_mapping: ["methodology_explanation"]
    context_requirements:
      stages: ["information"]
    risk_cost: 0.6
    slots: []

  - id: "info_location"
    rule_version: "1.0.0"
    priority: 60
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "onde"
    pattern: '\b(onde\s+fica|endereço|localização|unidade|telefone|horário\s+de\s+funcionamento)\b'
    description: "Location and contact information"
    node_mapping: ["information"]
    context_requirements:
      stages: ["information"]
    risk_cost: 0.5
    slots: []

  - id: "info_results"
    rule_version: "1.0.0"
    priority: 58
    lang: "pt"
    channels: ["whatsapp", "web", "app"]  
    prefilter_literal: "resultado"
    pattern: '\b(resultado|melhora|progresso|sucesso|funciona\s+mesmo)\b'
    description: "Results and effectiveness inquiry"
    node_mapping: ["information"]
    context_requirements:
      stages: ["information"]
    risk_cost: 0.6
    slots: []

  # ===============================
  # SCHEDULING RULES
  # ===============================

  - id: "scheduling_direct_booking"
    rule_version: "1.0.0"
    priority: 85
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "agendar"
    pattern: '\b(quero\s+agendar|vou\s+agendar|quero\s+marcar|vou\s+marcar|agendar|marcar)\b'
    description: "Direct booking intent"
    node_mapping: ["scheduling", "availability_check"]
    context_requirements:
      stages: ["information", "scheduling"]
    risk_cost: 0.3
    slots: []

  - id: "scheduling_visit_request"
    rule_version: "1.0.0"
    priority: 83
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "visita"
    pattern: '\b(visita|apresentação|conhecer\s+a\s+unidade|consulta|aula\s+experimental)\b'
    description: "Visit or trial class request"
    node_mapping: ["scheduling", "availability_check"]
    context_requirements:
      stages: ["information", "scheduling"]
    risk_cost: 0.3
    slots: []

  - id: "scheduling_availability"
    rule_version: "1.0.0"
    priority: 80
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "quando"
    pattern: '\b(quando|horário|disponível|livre|disponibilidade|que\s+horas|que\s+dia)\b'
    description: "Availability inquiry"
    node_mapping: ["availability_check", "slot_presentation"]
    context_requirements:
      stages: ["scheduling"]
    risk_cost: 0.4
    slots:
      - name: "date_preferences"
        group: "availability_request"
        required: false

  - id: "scheduling_time_preference"
    rule_version: "1.0.0"
    priority: 75
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "manhã"
    pattern: '\b(manhã|tarde|morning|afternoon|(?P<time_preference>\d{1,2}h?\d{0,2}))\b'
    description: "Time preference specification"
    node_mapping: ["slot_selection", "availability_check"]
    context_requirements:
      stages: ["scheduling"]
    risk_cost: 0.4
    slots:
      - name: "time_preference"
        group: "time_preference"
        required: false

  - id: "scheduling_weekday"
    rule_version: "1.0.0"
    priority: 73
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "segunda"
    pattern: '\b(?P<weekday>segunda|terça|quarta|quinta|sexta|sábado|domingo)\b'
    description: "Weekday preference"
    node_mapping: ["slot_selection", "availability_check"]
    context_requirements:
      stages: ["scheduling"]
    risk_cost: 0.4
    slots:
      - name: "date_preferences"
        group: "weekday"
        required: false

  - id: "scheduling_reschedule"
    rule_version: "1.0.0"
    priority: 70
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "remarcar"
    pattern: '\b(cancelar|remarcar|mudar\s+horário|trocar\s+data)\b'
    description: "Reschedule or cancel request"
    node_mapping: ["scheduling", "slot_selection"]
    context_requirements:
      stages: ["scheduling", "confirmation"]
    risk_cost: 0.5
    slots: []

  # ===============================
  # CONFIRMATION RULES
  # ===============================

  - id: "confirmation_confirmed"
    rule_version: "1.0.0"
    priority: 90
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "confirmo"
    pattern: '\b(confirmo|confirmado|tudo\s+certo|perfeito|ok|está\s+bem)\b'
    description: "Positive confirmation"
    node_mapping: ["confirmation", "appointment_confirmed"]
    context_requirements:
      stages: ["validation", "confirmation"]
    risk_cost: 0.2
    slots: []

  - id: "confirmation_email"
    rule_version: "1.0.0"
    priority: 85
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "email"
    pattern: '\b(meu\s+(email|e-mail)|contato|(?P<contact_email>[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}))\b'
    description: "Email address provision"
    node_mapping: ["validation", "contact_confirmation"]
    context_requirements:
      stages: ["validation", "confirmation"]
    risk_cost: 0.3
    slots:
      - name: "contact_email"
        group: "contact_email"
        required: false
        validation: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'

  - id: "confirmation_phone"
    rule_version: "1.0.0"
    priority: 83
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "telefone"
    pattern: '\b(telefone|celular|whatsapp|contato|(?P<phone_number>\d{2}\s*\d{4,5}-?\d{4}))\b'
    description: "Phone number confirmation"
    node_mapping: ["validation", "contact_confirmation"]
    context_requirements:
      stages: ["validation", "confirmation"]
    risk_cost: 0.3
    slots:
      - name: "phone_number"
        group: "phone_number"
        required: false

  # ===============================
  # CLARIFICATION RULES
  # ===============================

  - id: "clarification_confusion"
    rule_version: "1.0.0"
    priority: 85
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "não"
    pattern: '\b(não\s+entendo|não\s+sei|confuso|confusa|como\s+assim|o\s+que\s+significa)\b'
    description: "User confusion or lack of understanding"
    node_mapping: ["clarification"]
    context_requirements: {}  # Available from any stage
    risk_cost: 0.6
    slots: []

  - id: "clarification_repeat"
    rule_version: "1.0.0"
    priority: 80
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "repetir"
    pattern: '\b(pode\s+repetir|de\s+novo|again|não\s+ficou\s+claro|explica\s+melhor)\b'
    description: "Request to repeat or clarify"
    node_mapping: ["clarification"]
    context_requirements: {}
    risk_cost: 0.5
    slots: []

  - id: "clarification_multiple_questions"
    rule_version: "1.0.0"
    priority: 75
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "???"
    pattern: '\?{2,}'
    description: "Multiple question marks indicating confusion"
    node_mapping: ["clarification"]
    context_requirements: {}
    risk_cost: 0.7
    slots: []

  # ===============================
  # OBJECTION HANDLING RULES
  # ===============================

  - id: "objection_price"
    rule_version: "1.0.0"
    priority: 75
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "caro"
    pattern: '\b(caro|expensive|muito\s+dinheiro|não\s+posso\s+pagar)\b'
    description: "Price objection"
    node_mapping: ["objection_handling"]
    context_requirements:
      stages: ["information", "scheduling"]
    risk_cost: 1.2
    slots: []

  - id: "objection_distance"
    rule_version: "1.0.0"
    priority: 73
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "longe"
    pattern: '\b(longe|distante|far|muito\s+longe)\b'
    description: "Distance/location objection"
    node_mapping: ["objection_handling"]
    context_requirements:
      stages: ["information", "scheduling"]
    risk_cost: 1.0
    slots: []

  - id: "objection_time"
    rule_version: "1.0.0"
    priority: 70
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "tempo"
    pattern: '\b(não\s+tenho\s+tempo|busy|ocupado|sem\s+tempo)\b'
    description: "Time constraint objection"
    node_mapping: ["objection_handling"]
    context_requirements:
      stages: ["information", "scheduling"]
    risk_cost: 1.1
    slots: []

  # ===============================
  # HANDOFF RULES
  # ===============================

  - id: "handoff_human_request"
    rule_version: "1.0.0"
    priority: 95
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "atendente"
    pattern: '\b(falar\s+com|atendente|pessoa|humano|representante)\b'
    description: "Request to speak with human agent"
    node_mapping: ["handoff"]
    context_requirements: {}
    risk_cost: 0.1
    slots: []

  - id: "handoff_frustration"
    rule_version: "1.0.0"
    priority: 90
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "ajudando"
    pattern: '\b(não\s+está\s+ajudando|muito\s+confuso|desisto|cansei|chato)\b'
    description: "User frustration with automated system"
    node_mapping: ["handoff", "error_recovery"]
    context_requirements: {}
    risk_cost: 0.2
    slots: []

  - id: "handoff_dissatisfaction"
    rule_version: "1.0.0"
    priority: 85
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "ruim"
    pattern: '\b(ruim|péssimo|horrível|não\s+gostei|não\s+serve)\b'
    description: "Dissatisfaction with service"
    node_mapping: ["handoff", "error_recovery"]
    context_requirements: {}
    risk_cost: 0.3
    slots: []

  # ===============================
  # COMPLETION RULES
  # ===============================

  - id: "completion_success"
    rule_version: "1.0.0"
    priority: 85
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "obrigado"
    pattern: '\b(obrigado|obrigada|thank\s+you|perfeito|ótimo|excelente)\b'
    description: "Successful completion gratitude"
    node_mapping: ["completed"]
    context_requirements:
      stages: ["confirmation", "completed"]
    risk_cost: 0.1
    slots: []

  - id: "completion_goodbye"
    rule_version: "1.0.0"
    priority: 80
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "tchau"
    pattern: '\b(tchau|bye|até\s+logo|até\s+mais|goodbye)\b'
    description: "Conversation ending"
    node_mapping: ["completed"]
    context_requirements: {}
    risk_cost: 0.1
    slots: []

  # ===============================
  # EMERGENCY PROGRESSION RULES 
  # ===============================

  - id: "emergency_progression_urgent"
    rule_version: "1.0.0"
    priority: 95
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "urgente"
    pattern: '\b(urgente|emergency|emergência|crítico|imediato|hoje)\b'
    description: "Emergency or urgent assistance requests"
    node_mapping: ["emergency_progression"]
    context_requirements: {}  # Available from any stage
    risk_cost: 0.1
    slots: []

  - id: "emergency_progression_problem"
    rule_version: "1.0.0"
    priority: 90
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "problema"
    pattern: '\b(problema\s+grave|situação\s+difícil|preciso\s+de\s+ajuda\s+agora)\b'
    description: "Problem requiring emergency assistance"
    node_mapping: ["emergency_progression"]
    context_requirements: {}
    risk_cost: 0.2
    slots: []

  # ===============================
  # QUALIFICATION NODE RULES
  # ===============================

  - id: "qualification_main_entry"
    rule_version: "1.0.0"
    priority: 75
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "informações"
    pattern: '\b(preciso\s+fornecer|vou\s+falar\s+sobre|informações\s+sobre\s+o\s+aluno)\b'
    description: "Main qualification stage entry"
    node_mapping: ["qualification"]
    context_requirements:
      stages: ["greeting", "qualification"]
    risk_cost: 0.5
    slots: []

  - id: "qualification_student_details"
    rule_version: "1.0.0"
    priority: 70
    lang: "pt"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "aluno"
    pattern: '\b(sobre\s+o\s+aluno|dados\s+do\s+estudante|informações\s+do\s+filho)\b'
    description: "Student details for qualification"
    node_mapping: ["qualification"]
    context_requirements:
      stages: ["qualification"]
    risk_cost: 0.4
    slots: []

  # ===============================
  # ENGLISH RULES (Secondary Language)
  # ===============================

  - id: "greeting_hello_en"
    rule_version: "1.0.0"
    priority: 70
    lang: "en"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "hello"
    pattern: '\b(hello|hi|good\s+morning|good\s+afternoon|good\s+evening)\b'
    description: "English greeting"
    node_mapping: ["greeting"]
    context_requirements:
      stages: ["greeting"]
    risk_cost: 1.2
    slots: []

  - id: "scheduling_appointment_en"
    rule_version: "1.0.0"
    priority: 65
    lang: "en"
    channels: ["whatsapp", "web", "app"]
    prefilter_literal: "schedule"
    pattern: '\b(schedule|appointment|book|visit|trial\s+class)\b'
    description: "English scheduling request"
    node_mapping: ["scheduling"]
    context_requirements:
      stages: ["scheduling"]
    risk_cost: 1.2
    slots: []